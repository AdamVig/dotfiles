#!/usr/bin/env bash

# This script must run after the OS-specific scripts because it depends on Nodenv.

_dir="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"

# shellcheck source=./lib/helpers
source "$_dir"/helpers

message "setting up Node..."

message "  %s" "installing Nodenv..."
nodenv_root="${XDG_DATA_HOME:-$HOME/.local/share}"/nodenv
mkdir -p "$nodenv_root"
if ! [ -d "$nodenv_root" ]; then
	if ! git clone https://github.com/nodenv/nodenv.git "$nodenv_root" > /dev/null; then
		fatal 'failed to clone Nodenv'
	fi
fi

eval "$("$nodenv_root"/bin/nodenv init -)"
message "  %s" "done installing Nodenv."

message "  %s" "installing Nodenv plugins..."
mkdir -p "$nodenv_root"/plugins

declare -a nodenv_plugins=(
	node-build
	nodenv-update
	nodenv-default-packages
	nodenv-package-rehash
)

for nodenv_plugin in "${nodenv_plugins[@]}"; do
	if ! [ -d "$nodenv_root"/plugins/"$nodenv_plugin" ]; then
		if ! git clone https://github.com/nodenv/"$nodenv_plugin".git "$nodenv_root"/plugins/"$nodenv_plugin" > /dev/null; then
			fatal "failed to install Nodenv plugin '$nodenv_plugin'"
		fi
	fi
done
message "  %s" "done installing Nodenv plugins."

message "  %s" "copying default packages file..."
cp "$_dir"/../config/npm-default-packages "$nodenv_root"/default-packages &> /dev/null || true
message "  %s" "done copying default packages file."

message "  %s" "getting latest Node version..."
# 1. Get list of Node versions
# 2. Filter to only get normal Node versions, like "  9.5.0"
# 3. Take last line of output which will be latest version
# 4. Remove the leading spaces
latest_node_version="$(nodenv install --list | grep -E '^[0-9\.]+$' | tail -1 | xargs)"
message "  %s" "done getting latest Node version."

if [ -n "$latest_node_version" ]; then
	message "  %s" "installing Node $latest_node_version and default npm packages..."
	if ! nodenv install --skip-existing "$latest_node_version" &> /dev/null; then
		fatal 'failed to install Node'
	fi

	if ! nodenv global "$latest_node_version"; then
		fatal 'failed to set gloabl Node version'
	fi

	message "  %s" "done installing Node and default npm packages."
else
	warn "could not get latest Node version; installation failed"
fi

message "  %s" "setting Python path..."
npm config set --global python "$(command -v python3)"
message "  %s" "done setting Python path."

message "done setting up Node."
