#!/usr/bin/env bash

_dir="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"

# shellcheck source=./lib/helpers
source "$_dir"/helpers

# shellcheck disable=SC2119
request-sudo

message "  %s" "setting up Linux..."

message "    %s" "installing essential tools..."
if command -v apt-get > /dev/null; then
    sudo apt-get update > /dev/null
    sudo apt-get install --yes build-essential curl file git > /dev/null
else
    error "could not find a supported package manager; skipping install"
fi
message "    %s" "done installing essential tools."

if ! command -v brew &> /dev/null; then
    message "    %s" "installing Linuxbrew..."
    set +eu
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
    set -eu
    eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv)
    message "    %s" "done installing Linuxbrew."
fi

readonly fonts_dir="$(xdg_data)"/fonts
if ! [ -d "$fonts_dir"/source-code-pro ]; then
	mkdir -p "$fonts_dir"
	message '    %s' 'installing Source Code Pro...'
	if ! git clone --depth 1 --branch release https://github.com/adobe-fonts/source-code-pro.git "$fonts_dir"/source-code-pro; then
		fatal 'failed to clone Git repository'
	fi
	if ! fc-cache "$fonts_dir"/source-code-pro; then
		fatal 'failed to generate font caches'
	fi
	message '    %s' 'done installing Source Code Pro.'
fi

message "  %s" "done setting up Linux."
