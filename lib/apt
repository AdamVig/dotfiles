#!/usr/bin/env bash

_dir="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"

# shellcheck source=./lib/helpers
source "$_dir"/helpers

log() {
	log_with_component apt "$@"
}

log_start 'setting up apt'

# shellcheck disable=SC2119
request_sudo

if ! [ -f /etc/os-release ]; then
	fatal '/etc/os-release is missing, cannot detect operating system'
fi

log_start 'detecting operating system'
# shellcheck source=/dev/null
source /etc/os-release
distro="$ID"
codename="$VERSION_CODENAME"
log "detected distribution \"${distro}\" version codename \"${codename}\""
log_end

log_start 'configuring repositories'
# $1: string that uniquely identifies repository
is_repository_configured() {
	grep --quiet --recursive "$1" /etc/apt/sources.list /etc/apt/sources.list.d/
}

# $1: human-readable name, used in filenames of sources file and key
# $2: URL to signing key
# $3: latter part of repository configuration string, e.g. "http://repository.spotify.com stable non-free", not
# including the arch or signed-by options
add_repository() {
	local friendly_name="${1-}"
	local key_url="${2-}"
	local repo_config="${3-}"

	local key_path=/usr/share/keyrings/"$friendly_name"-archive-keyring.gpg

	if ! _curl "$key_url" | request_sudo gpg --dearmor -o "$key_path"; then
		fatal 'failed to add key'
	fi

	echo "deb [arch=$(dpkg --print-architecture) signed-by=$key_path] $repo_config" |
		request_sudo tee /etc/apt/sources.list.d/"$friendly_name".list >/dev/null
}

# $1: human-readable name, used in filenames of sources file and key
# $2: fingerprint of signing key
# $3: latter part of repository configuration string, e.g. "http://repository.spotify.com stable non-free", not
# including the arch or signed-by options
add_ppa() {
	local key_fingerprint="${2-}"
	local repo_name="${3-}"

	add_repository \
		"$1" \
		"https://keyserver.ubuntu.com/pks/lookup?op=get&options=mr&search=0x${key_fingerprint}" \
		"http://ppa.launchpad.net/${repo_name}/ubuntu/ ${codename} main"
}

if ! is_repository_configured 'docker'; then
	log_start 'adding Docker repository'
	add_repository 'docker' 'https://download.docker.com/linux/ubuntu/gpg' "https://download.docker.com/linux/ubuntu ${codename} stable"
	log_end
fi

if ! is_repository_configured 'microsoft.com/repos/code'; then
	log_start 'adding Visual Studio Code repository'
	add_repository 'vscode' 'https://packages.microsoft.com/keys/microsoft.asc' 'https://packages.microsoft.com/repos/code stable main'
	log_end
fi

if ! is_repository_configured 'spotify'; then
	log_start 'adding Spotify repository'
	# https://www.spotify.com/us/download/linux/
	add_repository 'spotify' 'https://download.spotify.com/debian/pubkey_6224F9941A8AA6D1.gpg' 'http://repository.spotify.com stable non-free'
	log_end
fi

if ! is_repository_configured 'slack'; then
	log_start 'adding Slack repository'
	add_repository 'slack' 'https://packagecloud.io/slacktechnologies/slack/gpgkey' 'https://packagecloud.io/slacktechnologies/slack/debian/ jessie main'
	log_end
fi

if ! is_repository_configured 'signal'; then
	log_start 'adding Signal repository'
	add_repository 'signal' 'https://updates.signal.org/desktop/apt/keys.asc' 'https://updates.signal.org/desktop/apt xenial main'
	log_end
fi

if ! is_repository_configured 'git-core'; then
	log_start 'adding git repository'
	add_ppa 'git' 'E1DD270288B4E6030699E45FA1715D88E1DF1F24' 'git-core/ppa'
	log_end
fi

if ! is_repository_configured 'cli.github.com'; then
	log_start 'adding GitHub CLI repository'
	add_repository 'githubcli' 'https://cli.github.com/packages/githubcli-archive-keyring.gpg' 'https://cli.github.com/packages stable main'
	log_end
fi

if ! is_repository_configured 'mozillateam'; then
	log_start 'adding Mozilla Team repository'
	add_ppa 'mozillateam' '0AB215679C571D1C8325275B9BDB3D89CE49EC21' 'mozillateam/ppa'
	log_end
fi

if ! is_repository_configured 'eza'; then
	log_start 'adding Eza repository'
	add_repository 'eza' 'https://raw.githubusercontent.com/eza-community/eza/main/deb.asc' 'http://deb.gierens.de stable main'
	log_end
fi

if is_repository_configured 'azlux'; then
	log_start 'removing broot repository'
	request_sudo rm -f /etc/apt/sources.list.d/{azlux,broot}.list* /usr/share/keyrings/{azlux,broot}-archive-keyring.gpg
	log_end
fi

if is_repository_configured 'brave'; then
	log_start 'removing Brave repository'
	request_sudo rm -f /etc/apt/sources.list.d/brave.list* /usr/share/keyrings/brave-archive-keyring.gpg
	log_end
fi

# Chrome's .deb installs an invalid repository
if is_repository_configured 'chrome'; then
	log_start 'removing Chrome repository'
	request_sudo rm -f /etc/apt/sources.list.d/chrome.list*
	log_end
fi

# Remove previous workaround for installing Chromium
if is_repository_configured 'deb.debian.org/debian stable'; then
	log_start 'removing Debian Stable repository'
	log_start 'removing sources file'
	request_sudo rm -f /etc/apt/sources.list.d/debian-stable.list*
	log_end
	log_start 'removing apt policy'
	request_sudo rm -f /etc/apt/preferences.d/debian-chromium >/dev/null
	log_end
	log_end
fi

if is_repository_configured 'digikam'; then
	log_start 'removing digiKam repository'
	request_sudo rm -f /etc/apt/sources.list.d/digikam.list* /usr/share/keyrings/digikam-archive-keyring.gpg
	log_end
fi

if is_repository_configured 'yubico'; then
	log_start 'removing Yubico repository'
	request_sudo rm -f /etc/apt/sources.list.d/yubico.list* /usr/share/keyrings/yubico-archive-keyring.gpg
	log_end
fi

if is_repository_configured 'vivaldi'; then
	log_start 'removing Vivaldi repository'
	request_sudo rm -f /etc/apt/sources.list.d/vivaldi.list* /usr/share/keyrings/vivaldi-archive-keyring.gpg
	log_end
fi

if is_repository_configured 'ubuntu-elisp'; then
	log_start 'removing Ubuntu Emacs snapshot repository'
	request_sudo rm -f /etc/apt/sources.list.d/emacs.list* /usr/share/keyrings/emacs-archive-keyring.gpg
	log_end
fi

if is_repository_configured 'balena'; then
	log_start 'removing Balena Etcher repository'
	request_sudo rm -f /etc/apt/sources.list.d/balena.list* /usr/share/keyrings/balena-archive-keyring.gpg
	log_end
fi

log_end

if [ -f /etc/apt/preferences.d/firefox ] || [ -f /etc/apt/apt.conf.d/51unattended-upgrades-firefox ] || command -v firefox >/dev/null; then
	log_start 'removing Firefox'
	request_sudo rm -f /etc/apt/preferences.d/firefox /etc/apt/apt.conf.d/51unattended-upgrades-firefox
	request_sudo apt-get remove --yes firefox
	log_end
fi

log_start 'updating lists'
if request_sudo apt-get update >/dev/null; then
	log_end
else
	warn 'failed to update lists'
fi

log_start 'upgrading packages'
if request_sudo apt-get upgrade --yes --autoremove >/dev/null; then
	log_end
else
	warn 'failed to upgrade packages, continuing'
fi

declare -a packages=(
	# system dependencies
	apt-transport-https
	software-properties-common

	# default utilities
	gnupg
	openssh-server
	rsync
	wget

	# replacements of default utilities
	bat     # Better cat
	eza     # Better ls
	fd-find # Better find
	htop    # Better top
	httpie  # Better curl
	mosh    # Better ssh
	ripgrep # Better grep

	# command line tools
	brightnessctl # Control screen brightness
	fzf           # Fuzzy finder
	gh            # GitHub CLI
	gnuplot       # Command-line plotting
	graphviz      # Graph visualization tool
	imagemagick
	jq                 # JSON processor
	libglib2.0-dev-bin # For compiling .gresources files
	magic-wormhole     # Point-to-point file sharing
	p7zip
	pandoc
	playerctl         # Media player controller
	postgresql-client # PostgreSQL CLI
	tig               # Visual Git client
	tree
	units # Unit conversion calculator
	unzip
	v4l-utils   # Webcam control tools
	wine        # Support for Windows applications
	winetricks  # Tools for working with Wine
	wireguard   # VPN
	wireplumber # PipeWire tools, including wpctl
	wmctrl      # X window manager control CLI
	xclip       # Clipboard CLI
	xsel        # Clipboard CLI
	xdotool     # X input event generator
	xdg-utils

	# shell
	bash
	zsh

	# programming languages
	golang
	nodejs
	php
	python3
	ruby
	rustc

	# programming language tools
	composer    # PHP
	npm         # Node
	pipx        # Run Python CLI tools
	python3-pip # Python
	shellcheck  # Shell script linter

	# Docker
	docker-ce
	docker-ce-cli
	containerd.io
	docker-buildx-plugin
	docker-compose-plugin

	# applications
	code
	d-feet        # D-Bus debugger
	emacs         # Text editor
	flameshot     # Screenshot tool
	gnome-keyring # Secret manager
	gpsbabel      # GPS file conversion tool
	i3            # Window manager
	i3blocks      # Status bar generator
	inkscape
	kdiff3 # Merge tool
	libreoffice
	lxpolkit        # Polkit authentication agent
	meld            # Comparison tool for version control, files, and directories
	mpv             # Media player
	qemu-system-x86 # Virtual machine tool
	redshift        # Screen color temperature adjustment tool
	rofi            # Application launcher
	rpi-imager      # Raspberry Pi imager
	signal-desktop
	slack-desktop
	spotify-client
	steam
	thunderbird  # Email client
	virt-manager # Virtual machine manager

	# fonts
	fonts-noto
	fonts-noto-color-emoji
	fonts-open-sans
	fonts-roboto
)

log_start 'installing packages'
if ! request_sudo apt-get install --yes "${packages[@]}"; then
	warn 'failed to install apt packages; this may require manual resolution'
fi
log_end

declare -a unwanted_packages=(
	brave-browser # Web browser
	broot         # Better tree
	chromium
	copyq
	digikam   # Now installed as AppImage in ./linux-software
	docker.io # Replaced with official Docker package
	emacs-snapshot
	exa # Replaced by eza
	figma-linux
	firefox
	google-chrome-stable
	kitty # Now installed in ./linux-software
	lutris
	mosquitto         # MQTT broker and password tool
	mosquitto-clients # MQTT client
	vivaldi-stable

	# Used to be installed via .deb, now installed as a binary
	websocat

	x11vnc # X server VNC

	# Had been installed both via Apt and in ./linux-software
	yubikey-manager
)

log_start 'removing unwanted packages'
for unwanted_package in "${unwanted_packages[@]}"; do
	request_sudo apt-get remove --yes --autoremove "$unwanted_package" &>/dev/null || true
done
log_end

log_start 'installing packages from non-repository sources'
log_start 'installing balenaEtcher'
if ! install_deb_from_github_release 'balena-io/etcher' '_amd64.deb'; then
	fatal 'failed to install balenaEtcher'
fi
log_end

log_start 'installing Google Chrome'
if ! install_deb_from_url 'https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb'; then
	fatal 'failed to install Google Chrome'
fi
log_end

log_start 'installing Hugo'
if ! install_deb_from_github_release 'gohugoio/hugo' 'linux-amd64.deb'; then
	fatal 'failed to install Hugo'
fi
log_end

log_start 'installing hyperfine'
if ! install_deb_from_github_release 'sharkdp/hyperfine' '_amd64.deb'; then
	fatal 'failed to install hyperfine'
fi
log_end

log_start 'installing git-delta'
if ! install_deb_from_github_release 'dandavison/delta' '_amd64.deb'; then
	fatal 'failed to install git-delta'
fi
log_end

log_start 'installing glow'
if ! install_deb_from_github_release 'charmbracelet/glow' '_amd64.deb'; then
	fatal 'failed to install glow'
fi
log_end

log_start 'installing Minikube'
# https://minikube.sigs.k8s.io/docs/start/
minikube_url='https://storage.googleapis.com/minikube/releases/latest/minikube_latest_amd64.deb'
minikube_tmp="$(mktemp --suffix='.deb')"
if ! _curl "$minikube_url" --output "$minikube_tmp"; then
	fatal 'failed to download Minikube'
fi
# Avoid "Download is performed unsandboxed as root" warning
request_sudo chown -R _apt:root "$minikube_tmp"
# Ignore recommends because they include VirtualBox
if ! request_sudo apt-get install --yes --no-install-recommends "$minikube_tmp"; then
	fatal 'failed to install Minikube'
fi
request_sudo rm -f "$minikube_tmp"
log_end

log_start 'installing pastel'
if ! install_deb_from_github_release 'sharkdp/pastel' '_amd64.deb'; then
	fatal 'failed to install pastel'
fi
log_end

log_start 'installing Standard Notes'
if ! install_deb_from_github_release 'standardnotes/app' '-linux-amd64.deb'; then
	fatal 'failed to install Standard Notes'
fi
log_end

log_end

log_end
