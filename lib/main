#!/usr/bin/env bash

set -euo pipefail

_dir="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"

# shellcheck source=./lib/helpers
source "$_dir"/helpers

_dir="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"

# Ask for password at start
# shellcheck disable=SC2119
request-sudo

log 'symlinking dotfiles to your home directory...'
ln -sf "$_dir"/../.bashrc "$HOME"
ln -sf "$_dir"/../.profile "$HOME"

bin_dir="$HOME"/.local/bin
log "creating '$bin_dir'..."
mkdir -p "$bin_dir"
log "done creating '$bin_dir'."

config_dir="$(xdg_config)"
log "symlinking configurations to '$config_dir'..."
mkdir -p "$config_dir"/ripgrep
ln -sf "$_dir"/../config/ripgrep "$config_dir"/ripgrep/config

mkdir -p "$config_dir"/bat
ln -sf "$_dir"/../config/bat "$config_dir"/bat/config

if ! [ -d "$config_dir"/docker ]; then
	log "creating Docker configuration directory..."
	mkdir -p "$config_dir"/docker
fi

log 'running OS-specific scripts...'

if is_macos; then
	"$_dir"/macos
	"$_dir"/brew
elif is_linux; then
	"$_dir"/linux
	if is_ubuntu; then
		"$_dir"/ubuntu
		"$_dir"/remote-management
	fi
fi

"$_dir"/emacs
"$_dir"/git
"$_dir"/golang
"$_dir"/gpg
"$_dir"/node
"$_dir"/pip
"$_dir"/ssh
"$_dir"/thunderbird
"$_dir"/tmux
"$_dir"/vscode
"$_dir"/zsh
"$_dir"/profile-picture
"$_dir"/gh

if is_macos; then
	broot_root='org.dystroy.broot'
else
	broot_root='broot'
fi
broot_dir="$(xdg_config)"/"$broot_root"/launcher
if command -v broot >/dev/null && ! [ -f "$broot_dir"/installed-v1 ]; then
	message '  %s' 'installing broot shell function...'
	broot_launcher_dir="$broot_dir"/bash
	mkdir -p "$broot_launcher_dir"
	if ! broot --print-shell-function zsh >"$broot_launcher_dir"/br; then
		fatal 'failed to install broot shell function'
	fi
	broot --set-install-state installed
	message '  %s' 'done installing broot shell function.'
fi

log "done. start a new login shell or run 'source .zshrc'."
