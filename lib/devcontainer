#!/usr/bin/env bash

# shellcheck source=./lib/helpers
source "${BASH_SOURCE[0]%/*}/helpers"

log() {
	log_with_component devcontainer "$@"
}

cleanup_paths=()
cleanup() {
	if [[ ${#cleanup_paths[@]} == 0 ]]; then
		return
	fi
	rm -rf "${cleanup_paths[@]}" 2>/dev/null
}

trap cleanup EXIT

log_start 'setting up devcontainer'

log_start 'downloading all packages in parallel'
codex_bin_file=$(mktemp)
kitty_tarball_path_file=$(mktemp)
git_spice_tarball_path_file=$(mktemp)
yq_bin_file=$(mktemp)
cleanup_paths+=("$codex_bin_file" "$kitty_tarball_path_file" "$git_spice_tarball_path_file" "$yq_bin_file")
_curl "$(get_release_url 'openai/codex' 'codex-x86_64-unknown-linux-gnu.zst')" | unzstd --stdout >"$codex_bin_file" &
download_to_tmp "$(get_release_url 'kovidgoyal/kitty' 'x86_64.txz')" '.txz' >"$kitty_tarball_path_file" &
download_to_tmp "$(get_release_url 'abhinav/git-spice' '.Linux-x86_64.tar.gz')" '.tar.gz' >"$git_spice_tarball_path_file" &
_curl "$(get_release_url 'mikefarah/yq' 'linux_amd64')" >"$yq_bin_file" &

if command -v apt-get >/dev/null; then
	bat_deb_path_file=$(mktemp)
	delta_deb_path_file=$(mktemp)
	glow_deb_path_file=$(mktemp)
	cleanup_paths+=("$bat_deb_path_file" "$delta_deb_path_file" "$glow_deb_path_file")
	download_deb_from_github_release 'sharkdp/bat' '_amd64.deb' >"$bat_deb_path_file" &
	download_deb_from_github_release 'dandavison/delta' '_amd64.deb' >"$delta_deb_path_file" &
	download_deb_from_github_release 'charmbracelet/glow' '_amd64.deb' >"$glow_deb_path_file" &
fi

wait || fatal 'failed to download packages'
log_end

if command -v apt-get >/dev/null; then

	declare -a packages=(
		# replacements of default utilities
		"$(<"$bat_deb_path_file")"   # Better cat
		"$(<"$delta_deb_path_file")" # Better git diff
		eza                          # Better ls
		fd-find                      # Better find
		htop                         # Better top
		httpie                       # Better curl
		ripgrep                      # Better grep

		# command line tools
		fzf                         # Fuzzy finder
		"$(<"$glow_deb_path_file")" # Markdown viewer

		ed # Needed by `gh-pr-body-commits`
		emacs-nox
		hunspell       # Needed by Emacs config
		hunspell-en-us # Needed by Emacs config (dictionary)
		kitty-terminfo # For terminal colors
		zsh
	)

	log_start 'installing packages'
	if ! DEBIAN_FRONTEND=noninteractive request_sudo apt-get install --yes --no-install-recommends "${packages[@]}"; then
		warn 'failed to install apt packages; this may require manual resolution'
	fi
	log_end

	log_start 'linking fdfind to fd'
	mkdir -p "$HOME"/.local/bin
	_ln /usr/bin/fdfind "$HOME"/.local/bin/fd
	log_end
fi

log_start 'installing Codex'
if ! install --mode='u=rwx,go=rx' "$codex_bin_file" "$HOME"/.local/bin/codex; then
	fatal 'failed to install codex'
fi
log_end

log_start 'installing yq'
if ! install --mode='u=rwx,go=rx' "$yq_bin_file" "$HOME"/.local/bin/yq; then
	fatal 'failed to install yq'
fi
log_end

log_start 'installing git-spice'
git_spice_extracted_tmp="$(extract_tarball_to_tmp "$(<"$git_spice_tarball_path_file")")"
cleanup_paths+=("$git_spice_extracted_tmp")
install "$git_spice_extracted_tmp"/git-spice "$HOME"/.local/bin/git-spice
git_spice_config_path="$(xdg_config)/git-spice"
mkdir -p "$git_spice_config_path"
echo '{
  "services": {
    "https://github.com": {
      "secrets": {
        "token": {
          "value": "{\"AuthenticationToken\":null,\"github_cli\":true}"
        }
      }
    }
  }
}' >"$git_spice_config_path/secrets.json"
log_end

log_start 'installing kitty'
kitty_extracted_tmp="$(extract_tarball_to_tmp "$(<"$kitty_tarball_path_file")")"
cleanup_paths+=("$kitty_extracted_tmp")
mv "$kitty_extracted_tmp"/bin/kitten "$HOME"/.local/bin
log_end

log 'symlinking Git commit template and attributes'
config_path="$(xdg_config)"/git
mkdir -p "$config_path"
_ln "$script_dir"/../config/git/template "$config_path"/template
_ln "$script_dir"/../config/git/attributes "$config_path"/attributes

log_end
