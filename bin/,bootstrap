#!/usr/bin/env sh

if ! command -v uname >/dev/null; then
	echo 'error: uname is not available, cannot proceed'
fi

# If running on a fresh boot of macOS
if [ "$(uname)" = 'Darwin' ] && ! command -v realpath >/dev/null; then
	echo 'detected fresh macOS system, running pre-bootstrap steps...'
	if ! command -v brew >/dev/null; then
		echo "installing Homebrew..."
		/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
		echo "done installing Homebrew."
	fi

	echo 'installing dependencies...'
	brew install coreutils bash
	echo 'done installing dependencies.'

	echo 'done running pre-bootstrap steps, create a new shell and run this script again.'
	exit
fi

# If running on a fresh boot of a Linux system that uses apt
if command -v apt-get >/dev/null && ! command -v jq >/dev/null; then
	echo 'detected fresh Linux system, running pre-bootstrap steps...'
	echo 'updating apt lists...'
	sudo apt-get update >/dev/null
	echo 'done updating apt lists.'

	echo 'installing dependencies...'
	sudo apt-get install --yes build-essential curl file git jq >/dev/null
	echo 'done installing dependencies.'

	# Causes a crash (https://bugs.launchpad.net/ubuntu/+source/gnome-shell-extension-desktop-icons-ng/+bug/1926863)
	echo 'removing ding.js GNOME shell extension...'
	sudo apt remove --yes gnome-shell-extension-desktop-icons-ng
	echo 'done removing ding.js GNOME shell extension.'

	echo 'done running pre-bootstrap steps'
fi

exec "$(dirname "$(realpath "$0")")"/../lib/main
