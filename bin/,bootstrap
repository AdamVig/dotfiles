#!/usr/bin/env bash

if ! command -v uname >/dev/null; then
	echo 'error: uname is not available, cannot proceed'
	exit 1
fi

# If running on a fresh boot of macOS
if [ "$(uname)" = 'Darwin' ] && ! [ -f /opt/homebrew/bin/brew ]; then
	echo 'detected fresh macOS system, running pre-bootstrap steps...'
	echo "installing Homebrew..."
	/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
	echo "done installing Homebrew."

	eval "$(/opt/homebrew/bin/brew shellenv)"

	echo 'installing dependencies...'
	brew install coreutils bash
	echo 'done installing dependencies.'

	echo 'done running pre-bootstrap steps, create a new shell and run this script again.'
	exit
fi

# If running on a fresh boot of a Linux system that uses apt, including devcontainers
if command -v apt-get >/dev/null && (! command -v curl >/dev/null || [[ -v VSCODE_REMOTE_CONTAINERS_SESSION || -v REMOTE_CONTAINERS || -v IN_DEV_CONTAINER ]]); then
	echo 'detected fresh Linux system, running pre-bootstrap steps...'
	# Update only if /var/lib/apt/lists is missing/empty or if no apt operation has run in >1 day
	lock=/var/lib/dpkg/lock-frontend
	if ! find /var/lib/apt/lists -type f ! -name lock -quit 2>/dev/null >/dev/null ||
		[[ ! -e $lock ]] ||
		(($(date +%s) - $(stat -c %Y "$lock" 2>/dev/null || echo 0) > 86400)); then
		echo 'updating apt lists...'
		sudo apt-get --option='Acquire::Languages=none' update --quiet=2
		echo 'done updating apt lists'
	fi

	echo 'installing dependencies...'
	sudo apt-get install --yes build-essential curl file gettext git jq unzip zstd >/dev/null
	echo 'done installing dependencies.'

	echo 'done running pre-bootstrap steps'
fi

echo 'running lib/main...'
# Non-standard script directory detection to support fresh systems
script_dir="$(cd -P -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"
# shellcheck disable=SC1091
source "$script_dir"/../.profile
exec "$script_dir"/../lib/main
