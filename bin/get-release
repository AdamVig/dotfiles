#!/usr/bin/env bash

set -euo pipefail

# Wait for continuous integration to finish, refreshing at a set interval, then print out the list of releases
if ! check-installed gh https://cli.github.com/; then
	exit 1
fi

prev_releases=""

# If CI status is pending, get current list of releases then wait for CI to finish
if [ "$(gh pr view \
	--json=statusCheckRollup \
	--jq='.statusCheckRollup | map(.state) | any(. == "PENDING")')" = "true" ]; then
	# Get current list of releases, which will be diffed against later to show the new version
	prev_releases="$(gh release list)"

	echo "Waiting for CI..."
	watch-ci
fi

# Print list of releases, diffing against previous list of releases if it is set
if [ -n "$prev_releases" ]; then
	echo
	echo "New release:"
	# Diff, only displaying changed groups, and hiding any control characters
	diff \
		--ignore-all-space \
		--changed-group-format='%<%>' \
		--unchanged-group-format='' \
		<(echo "$prev_releases") <(gh release list)
else
	echo 'No CI status found, getting ten most recent releases...'
	gh release list --limit=10
fi
